<!DOCTYPE html>
<html lang="en">
    <head>
        <title>MakerDAO Chainlog</title>
        <meta charset="UTF-8">
        <meta name="referrer" content="origin">
        <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    </head>
    <body>
        <script>

const setUp = () => {
  providerValue.innerHTML = provider;
  call({
    to:   chainlog,
    data: "0x0f560cd7" // list()
  }, draw);
}

let provider;
window.addEventListener("load", () => {
  if (typeof window.ethereum !== "undefined") {
    window.ethereum.on("connect", conn => {
      provider = "metamask";
      chain = conn.chainId;
      setUp();
    });
  } else {
    provider = "infura";
    chain = "mainnet";
    setUp();
  }
});

const connTable = document.createElement("table");
connTable.style.backgroundColor = "lightgrey";
const providerRow = document.createElement("tr");
const providerName = document.createElement("td");
providerName.innerHTML = "provider:";
providerRow.append(providerName);
const providerValue = document.createElement("td");
providerValue.innerHTML = "loading…";
providerRow.append(providerValue);
connTable.append(providerRow);
document.body.append(connTable);

const canvas = document.createElement("div");
canvas.innerHTML = "loading…";
document.body.append(canvas);

const endpoint = 'https://mainnet.infura.io/v3/633f64adbe364bb88127348d4fcc21ef';
const chainlog = "0xdA0Ab1e0017DEbCd72Be8599041a2aa3bA7e740F";

const hex2a = hexx => { // adapted from https://stackoverflow.com/a/3745677/15857007
  const hex = hexx.toString();
  let str = '';
  for (let i = 0; i < hex.length; i += 2) {
    const ch = hex.substr(i, 2);
    if (ch === '00') continue;
    str += String.fromCharCode(parseInt(ch, 16));
  }
  return str;
}

const infuraCall = (params, callback) => {
  const options = {
    method: 'POST',
    body:   '{"jsonrpc": "2.0", "method": "eth_call", "params": [' + JSON.stringify(params) + ', "latest"], "id": 0 }'
  };
  const promise = fetch(endpoint, options);
  promise.then(response => response.json().then(content => callback(content.result)));
}

const call = (params, callback) => {
  if (provider === "metamask" && window.ethereum.isConnected()) {
    window.ethereum.request({
      method: "eth_call",
      params: [ params ]
    }).then(response => callback(response))
    .catch(() => infuraCall(params, callback));
  } else {
    infuraCall(params, callback);
  }
}

const getAddress = (keyHex, callback) => {
  call({
    to: chainlog,
    data: "0x21f8a721" + keyHex // getAddress(bytes32)
  }, addressHex => {
    const address = "0x" + addressHex.substring(26);
    callback(address);
  });
}

const draw = data => {
  canvas.innerHTML = "";
  const divVersion = document.createElement("div");
  divVersion.style.height = "50px";
  canvas.append(divVersion);
  call({
    to: chainlog,
    data: "0x54fd4d50" // version()
  }, versionString => {
    const versionHex = versionString.substring(2 + 2 * 32 * 2);
    const version = hex2a(versionHex);
    divVersion.innerHTML = "Chainlog " + chainlog + " version " + version + " on Ethereum mainnet";
  });
  data = data.substring(2 + 64 * 2);
  const table = document.createElement("table");
  const header = document.createElement("tr");

  const tdKey = document.createElement("td");
  const filter = document.createElement("input");
  filter.setAttribute("placeholder", "filter");
  const trs = document.getElementsByClassName("tr");
  filter.addEventListener("keyup", () => {
    for (let i = 0; i < trs.length; i++) {
      const tr = trs[i];
      const key = tr.children[0].innerHTML;
      const queryLower = filter.value.toLowerCase();
      const keyLower = key.toLowerCase();
      if (keyLower.includes(queryLower)) {
        tr.style.display = "table-row";
        tr.setAttribute("name", "tr-visible");
        if (tr.children[1].innerHTML.includes("<button>")) {
          const viewAll = document.getElementById("viewAll");
          viewAll.style.display = "block";
        }
      } else {
        tr.style.display = "none";
        tr.setAttribute("name", "tr-hidden");
    }
    }
  });
  tdKey.append(filter);
  header.append(tdKey);

  const tdView = document.createElement("td");
  const viewAll = document.createElement("button");
  viewAll.setAttribute("id", "viewAll");
  viewAll.innerHTML = "view all";
  viewAll.addEventListener("click", () => {
    viewAll.innerHTML = "loading…";
    viewAll.setAttribute("disabled", true);
    const trs = document.getElementsByName("tr-visible");
    for (let i = 0; i < trs.length; i++) {
      const tr = trs[i];
      const tds = tr.children;
      const tdKey = tds[0];
      const keyHex = tdKey.id;
      getAddress(keyHex, address => {
        const tdView = tds[1];
        tdView.innerHTML = address;
        if (i === trs.length - 1) {
          viewAll.style.display = "none";
          viewAll.innerHTML = "view all";
          viewAll.removeAttribute("disabled");
        }
      });
    }
  });
  tdView.append(viewAll);
  header.append(tdView);

  table.append(header);
  for (let i = 0; i < data.length; i += 64) {
    const tr = document.createElement("tr");
    tr.setAttribute("class", "tr");
    tr.setAttribute("name", "tr-visible");
    tr.addEventListener("mouseover", () => {
      tr.style.backgroundColor = "lightgrey";
    });
    tr.addEventListener("mouseout", () => {
      tr.style.backgroundColor = "initial";
    });

    const tdKey = document.createElement("td");
    const keyHex = data.substring(i, i + 64);
    const key = hex2a(keyHex);
    tdKey.innerHTML = key;
    tdKey.setAttribute("id", keyHex);
    tr.append(tdKey);

    const tdView = document.createElement("td");
    const view = document.createElement("button");
    view.innerHTML = "view";
    view.addEventListener("click", () => {
      getAddress(keyHex, address => {
        tdView.innerHTML = address;
      });
    });
    tdView.append(view);
    tr.append(tdView);

    const tdCopy = document.createElement("td");
    const copy = document.createElement("button");
    copy.setAttribute("class", "copy");
    copy.innerHTML = "copy";
    copy.addEventListener("click", () => {
      getAddress(keyHex, address => {
        tdView.innerHTML = address;
        navigator.clipboard.writeText(address);
        const copies = document.getElementsByClassName("copy");
        for (let i = 0; i < copies.length; i++) {
          const copy = copies[i];
          copy.innerHTML = "copy";
        }
        copy.innerHTML = "copied";
      });
    });
    tdCopy.append(copy);
    tr.append(tdCopy);

    const tdEscan = document.createElement("td");
    const escan = document.createElement("button");
    escan.innerHTML = "Etherscan";
    escan.addEventListener("click", () => {
      getAddress(keyHex, address => {
        tdView.innerHTML = address;
        window.open("https://etherscan.io/address/" + address);
      });
    });
    tdEscan.append(escan);
    tr.append(tdEscan);

    table.append(tr);
  }
  canvas.append(table);
}


        </script>
    </body>
</html>
