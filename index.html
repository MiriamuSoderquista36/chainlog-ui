<!DOCTYPE html>
<html lang="en">
    <head>
        <title>MakerDAO Chainlog</title>
        <meta charset="UTF-8">
        <meta name="referrer" content="origin">
    </head>
    <body>
        loading…
        <script>
const chainlog = "0xdA0Ab1e0017DEbCd72Be8599041a2aa3bA7e740F";
const hex2a = hexx => { // adapted from https://stackoverflow.com/a/3745677/15857007
  const hex = hexx.toString();
  let str = '';
  for (let i = 0; i < hex.length; i += 2) {
    const ch = hex.substr(i, 2);
    if (ch === '00') continue;
    str += String.fromCharCode(parseInt(ch, 16));
  }
  return str;
}
const call = (params, callback) => {
  const url = 'https://mainnet.infura.io/v3/633f64adbe364bb88127348d4fcc21ef';
  const options = {
    method: 'POST',
    body:   '{"jsonrpc": "2.0", "method": "eth_call", "params": [' + JSON.stringify(params) + ', "latest"], "id": 0 }'
  };
  const promise = fetch(url, options);
  promise.then(response => response.json().then(content => callback(content.result)));
}
const getAddress = (keyHex, callback) => {
  call({
    to: chainlog,
    data: "0x21f8a721" + keyHex // getAddress(bytes32)
  }, addressHex => {
    const address = "0x" + addressHex.substring(26);
    callback(address);
  });
}
const listKeys = data => {
  document.body.innerHTML = "";
  data = data.substring(2 + 64 * 2);
  const table = document.createElement("table");
  const header = document.createElement("tr");

  const tdKey = document.createElement("td");
  const filter = document.createElement("input");
  filter.setAttribute("placeholder", "filter");
  const trs = document.getElementsByClassName("tr");
  filter.addEventListener("keyup", () => {
    for (let i = 0; i < trs.length; i++) {
      const tr = trs[i];
      const key = tr.children[0].innerHTML;
      const queryLower = filter.value.toLowerCase();
      const keyLower = key.toLowerCase();
      if (keyLower.includes(queryLower)) {
        tr.style.display = "table-row";
        tr.setAttribute("name", "tr-visible");
        if (tr.children[1].innerHTML.includes("<button>")) {
          const viewAll = document.getElementById("viewAll");
          viewAll.style.display = "block";
        }
      } else {
        tr.style.display = "none";
        tr.setAttribute("name", "tr-hidden");
    }
    }
  });
  tdKey.append(filter);
  header.append(tdKey);

  const tdView = document.createElement("td");
  const viewAll = document.createElement("button");
  viewAll.setAttribute("id", "viewAll");
  viewAll.innerHTML = "view all";
  viewAll.addEventListener("click", () => {
    viewAll.innerHTML = "loading…";
    viewAll.setAttribute("disabled", true);
    const trs = document.getElementsByName("tr-visible");
    for (let i = 0; i < trs.length; i++) {
      const tr = trs[i];
      const tds = tr.children;
      const tdKey = tds[0];
      const keyHex = tdKey.id;
      getAddress(keyHex, address => {
        const tdView = tds[1];
        tdView.innerHTML = address;
        if (i === trs.length - 1) {
          viewAll.style.display = "none";
          viewAll.innerHTML = "view all";
          viewAll.removeAttribute("disabled");
        }
      });
    }
  });
  tdView.append(viewAll);
  header.append(tdView);

  table.append(header);
  for (let i = 0; i < data.length; i += 64) {
    const tr = document.createElement("tr");
    tr.setAttribute("class", "tr");
    tr.setAttribute("name", "tr-visible");

    const tdKey = document.createElement("td");
    const keyHex = data.substring(i, i + 64);
    const key = hex2a(keyHex);
    tdKey.innerHTML = key;
    tdKey.setAttribute("id", keyHex);
    tr.append(tdKey);

    const tdView = document.createElement("td");
    const view = document.createElement("button");
    view.innerHTML = "view";
    view.addEventListener("click", () => {
      getAddress(keyHex, address => {
        tdView.innerHTML = address;
      });
    });
    tdView.append(view);
    tr.append(tdView);

    const tdCopy = document.createElement("td");
    const copy = document.createElement("button");
    copy.innerHTML = "copy";
    copy.addEventListener("click", () => {
      getAddress(keyHex, address => {
        navigator.clipboard.writeText(address);
        copy.innerHTML = "copied";
      });
    });
    tdCopy.append(copy);
    tr.append(tdCopy);

    table.append(tr);
  }
  document.body.append(table);
}
call({
  to:   chainlog,
  data: "0x0f560cd7" // list()
}, listKeys);
        </script>
    </body>
</html>
